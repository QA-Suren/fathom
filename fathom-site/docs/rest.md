## About

**Fathom-REST** is an opinionated, injectable, & thin scaffolding for the [Pippo Micro Webframework](http://pippo.ro).

Pippo is a modest, hackable framework for writing RESTful web applications.  It provides easy-to-use filtering, routing, template engine integration, localization (i18n), [Webjars] support, and [pretty-time] datetime rendering.

## Installation

Add the **Fathom-REST** artifact.

```xml
<dependency>
    <groupId>com.gitblit.fathom</groupId>
    <artifactId>fathom-rest</artifactId>
    <version>${fathom.version}</version>
</dependency>
```

## Layout

```
YourApp
└── src
    ├── main
    │   ├── java
    │   │   ├── conf
    │   │   │   ├── Routes.java
    │   │   │   ├── messages.properties
    │   │   │   ├── messages_en.properties
    │   │   │   └── messages_ro.properties
    │   │   ├── controllers
    │   │   │   ├── EmployeeController.java
    │   │   │   └── ItemController.java
    │   │   └── templates
    │   │       ├── base.ftl
    │   │       ├── employee.ftl
    │   │       ├── employees.ftl
    │   │       ├── index.ftl
    │   │       └── login.ftl
    │   └── resources
    │       └── public
    │           └── css
    │               └── custom.css
    └── test
        ├── java
        │   ├── conf
        │   │   └── RoutesTest.java
        │   └── controllers
        │       └── ApiControllerTest.java
        └── resources
```

## Configuration

The standard Pippo settings are directly configured through your `conf/default.conf` file.

```hocon
application {
  # The prefix to use for internal cookies generated by Fathom.
  cookie.prefix = "FATHOM"

  # Uploaded Files
  uploadLocation = ""
  uploadMaxSize = 0

  # ISO Language Code, optionally followed by a valid ISO Country Code.
  # e.g. application.languages=en,de,es,fr,ru
  languages = [en, de, es, fr, ro, ru]
}

# You can optionally relocate templates from the default classpath location
template.pathPrefix = ""
```

## Usage

Almost everything you can read in the official [Pippo] documentation applies to **Fathom-REST**.

## Differences

**Fathom-REST** takes a slightly different approach to URL mapping compared to upstream Pippo.

In Pippo, the *Application* class is the core component and is used to register everything.

In **Fathom-REST** the Pippo *Application* is an internal component and not meant to be accessed directly.  Instead, Filters, Routes, and Controllers are registered through the `conf/Routes.java` class.

### Routes.java

Route registration in **Fathom-REST** is almost identical to the process in [Pippo Routes].

```java
package conf;

public class Routes extends RoutesModule {

  @Inject
  EmployeeDao employeeDao;

  @Override
  protected void setup() {

    // add a filter for all requests to stamp some diagnostic headers
    ALL("/.*", (ctx) -> {
      ctx.setHeader("app-name", getSettings().getApplicationName());
      ctx.setHeader("app-version", getSettings().getApplicationVersion());
    }).named("Metadata Filter");

    // add a handler for the root page and report it's usage through Metrics
    GET("/", (ctx) -> {
      int count = employeeDao.getAll().size();
      ctx.text().send("Employee Phonebook\n\nThere are {} employees.", count);
    }).named("Home Page").metered();

    // add all annotated controllers found in the classpath
    addAnnotatedControllers();
  }

}
```

### Controllers

Controllers in **Fathom-REST** are almost the same as in [Pippo] but Fathom Controllers allow use of [AOP method interceptors], feature automatic *Content-Type negotiation*, allow transparent parameter names, and enable custom Argument Extractors.

```java
package controllers;

// To be discoverable, a controller must be annotated with @ControllerPath.
@ControllerPath("/employees")
public class MyController extends Controller {

  @Inject
  EmployeeDao employeeDao;

  @GET("/?")
  @Produces(Produces.HTML)
  @Counted
  public void index() {
    List<Employee> list = employeeDao.getAll();
    getResponse().bind("employees", list).render("employees");
  }

  @GET("/all")
  @Produces({Produces.JSON, Produces.XML})
  @Metered
  public void getAll() {
    List<Employee> list = employeeDao.getAll();
    getResponse().ok().send(list);
  }

  @GET("/{id: [0-9]+}")
  @Produces({Produces.JSON, Produces.XML})
  @Metered
  public void getEmployee(int id) {
    // The method parameter name "id" matches the url parameter name "id"
    Employee employee = employeeDao.get(id);
    if (employee == null) {
      getResponse().notFound().send("Failed to find employee {}!", id);
    } else {
      getResponse().ok().send(employee);
    }
  }

}
```

#### Produces and Negotiation

The *Produces* annotation declares the content-types which may be generated by the Controller method.  You are not required to specify a *Produces* annotation but it may make the intent of your Controller methods more clear and may be necessary for future module integrations such as [Swagger] or [RAML].

If a Controller method *Produces* multiple types, the first specified *Content-Type* is used as the default.  A negotiation process will automatically occur to determine and attempt to use the *Accept-Type* preferred by the *Request*.  If one of the preferred *Accept-Types* match one of the *Produces* types, the matching *Accept-Type* will be used for  *Response* generation.  If none of the *Accept-Types* match the *Produces* types, then the default *Content-Type* as declared by the *Produces* annotation will be used for the *Response*.

#### Transparent Parameter Names

**Fathom-REST** Controllers make use of the `-parameters` flag of the Java 8 javac compiler.  This flag embeds the names of method parameters in the generated *.class* files.  By default Java 8 does not compile with this flag set so you must specify the `-parameters` compiler argument for your build system and your IDE.

You are not required to use this feature.  But if you choose to skip specifying the `-parameters` flag then you **must** annotate each Controller method parameter with `@Param("name")`.  Obviously this will make your Controller method signatures more verbose and you will also be double-maintaining parameter name mappings.

#### Standard Argument Extractors

Argument Extractors allow you to specify an annotation which instructs **Fathom-REST** how to provide the value of an argument to your Controller method.

**Fathom-REST** includes the following argument extractors:

| Annotation | Use-Case                                                                            |
|------------|-------------------------------------------------------------------------------------|
| `@Bean`    | Extract url parameters, query parameters, and/or form fields to a Java object       |
| `@Body`    | Marshall a Request body to a Java type via a *Content Type Engine* (e.g. JSON, XML) |
| `@Header`  | Extract a Request header to a standard Java type                                    |
| `@Local`   | Extract a temporary value stored locally within the Request/Response Context        |
| `@Param`   | Extract an url parameter, query parameter, or form field to a standard Java type    |
| `@Session` | Extract a value stored within the Session                                           |

#### Metrics

In the above example Controller you may notice that each of the methods is annotated a [Metrics](metrics.md) collection annotation.

**Fathom-REST** Controllers are a great place to collect metrics data.

## Template Engines

All standard [Pippo] template engines are supported.

| Engine         | Artifact                     |
|----------------|------------------------------|
| [Freemarker]   | [ro.pippo:pippo-freemarker]  |
| [Jade]         | [ro.pippo:pippo-jade]        |
| [Pebble]       | [ro.pippo:pippo-pebble]      |
| [Trimou]       | [ro.pippo:pippo-trimou]      |
| [Groovy]       | [ro.pippo:pippo-groovy]      |

## Content-Type Engines

All standard [Pippo] content-type engines are supported.

| Content-Type | Engine           | Artifact                     |
|--------------|------------------|------------------------------|
| XML          | JAXB             | *default, built-in*          |
| XML          | [XStream]        | [ro.pippo:pippo-xstream]     |
| JSON         | [GSON]           | [ro.pippo:pippo-gson]        |
| JSON         | [FastJSON]       | [ro.pippo:pippo-fastjson]    |
| JSON         | [Jackson]        | [ro.pippo:pippo-jackson]     |
| YAML         | [SnakeYAML]      | [ro.pippo:pippo-snakeyaml]   |


[Pippo]: http://pippo.ro
[Pippo Routes]: http://www.pippo.ro/doc/routes.html
[AOP method interceptors]: https://github.com/google/guice/wiki/AOP

[Swagger]: http://swagger.io
[RAML]: http://raml.org

[Webjars]: http://www.webjars.org
[pretty-time]: http://www.ocpsoft.org/prettytime
[Freemarker]: http://freemarker.org
[Jade]: https://github.com/neuland/jade4j
[Pebble]: http://www.mitchellbosecke.com/pebble/home
[Trimou]: http://trimou.org
[Groovy]: https://github.com/decebals/pippo/tree/master/pippo-groovy

[XStream]: https://github.com/x-stream/xstream
[GSON]: https://github.com/google/gson
[FastJSON]: https://github.com/alibaba/fastjson
[Jackson]: https://github.com/FasterXML/jackson
[SnakeYAML]: https://bitbucket.org/asomov/snakeyaml

[ro.pippo:pippo-freemarker]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-freemarker"
[ro.pippo:pippo-jade]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-jade"
[ro.pippo:pippo-pebble]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-pebble"
[ro.pippo:pippo-trimou]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-trimou"
[ro.pippo:pippo-groovy]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-groovy"

[ro.pippo:pippo-xstream]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-xstream"
[ro.pippo:pippo-gson]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-gson"
[ro.pippo:pippo-fastjson]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-fastjson"
[ro.pippo:pippo-jackson]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-jackson"
[ro.pippo:pippo-snakeyaml]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-snakeyaml"
