## About

**Fathom-REST** is an opinionated, injectable, & thin scaffolding for the [Pippo Micro Webframework](http://pippo.ro).

Pippo is a modest, hackable framework for writing RESTful web applications.  It provides easy-to-use filtering, routing, template engine integration, localization (i18n), [Webjars] support, and [pretty-time] datetime rendering.

## Installation

Add the **Fathom-REST** artifact.

```xml
<dependency>
    <groupId>com.gitblit.fathom</groupId>
    <artifactId>fathom-rest</artifactId>
    <version>${fathom.version}</version>
</dependency>
```

## Layout

```
YourApp
└── src
    ├── main
    │   ├── java
    │   │   ├── conf
    │   │   │   └── Routes.java
    │   │   └── controllers
    │   │       ├── EmployeeController.java
    │   │       └── ItemController.java
    │   └── resources
    │       ├── conf
    │       │   ├── messages.properties
    │       │   ├── messages_en.properties
    │       │   └── messages_ro.properties
    │       ├── public
    │       │   └── css
    │       │       └── custom.css
    │       └── templates
    │           ├── base.ftl
    │           ├── employee.ftl
    │           ├── employees.ftl
    │           ├── index.ftl
    │           └── login.ftl
    └── test
        └── java
            ├── conf
            │   └── RoutesTest.java
            └── controllers
                └── ApiControllerTest.java
```
!!! Note
    This *module* depends on the value of the `application.package` setting.  If you have specified an application package then your Routes class must be `${package}/conf/Routes.java`.

## Configuration

The standard Pippo settings are directly configured through your `conf/default.conf` resource file.

```hocon
application {
  # The prefix to use for internal cookies generated by Fathom.
  cookie.prefix = "FATHOM"

  # ISO Language Code, optionally followed by a valid ISO Country Code.
  # e.g. application.languages=en,de,es,fr,ru
  languages = [en, de, es, fr, ro, ru]
}
```

### Changing the Basepath

By default, **Fathom-REST** will serve all requests to `/`.  You may specify a different basepath in your `conf/default.conf` resource file.

```hocon
servlets {
  fathom.rest.RestServlet = "/mypath"
}
```

## Usage

Almost everything you can read in the official [Pippo] documentation applies to **Fathom-REST**.

## Differences

**Fathom-REST** takes a slightly different approach to URL mapping compared to upstream Pippo.

In Pippo, the *Application* class is the core component and is used to register everything.

In **Fathom-REST** the Pippo *Application* is an internal component and not meant to be accessed directly.  Filters, Routes, and Controllers are registered through the `conf/Routes.java` class.

### Routes.java

Route registration in **Fathom-REST** is almost identical to the process in [Pippo Routes].

```java
package conf;

public class Routes extends RoutesModule {

  @Inject
  EmployeeDao employeeDao;

  @Override
  protected void setup() {

    // add a filter for all requests to stamp some diagnostic headers
    ALL("/.*", (ctx) -> {
      ctx.setHeader("app-name", getSettings().getApplicationName());
      ctx.setHeader("app-version", getSettings().getApplicationVersion());
    });

    // add a handler for the root page and report it's usage through Metrics
    GET("/", (ctx) -> {
      int count = employeeDao.getAll().size();
      ctx.text().send("Employee Phonebook\n\nThere are {} employees.", count);
    });

    // add all annotated controllers found in the classpath
    addAnnotatedControllers();
  }

}
```

#### Naming Routes

You may name your routes.  This information is used in the registered routes table displayed at startup and during runtime logging of route dispatching.

```java
GET("/", (ctx) -> ctx.text().send("Hello World!")).named("Home Page");
```

#### Metrics Collection

It's very easy to collect [Metrics](metrics.md) data about your *routes*.

```java
GET("/", (ctx) -> ctx.text().send("Hello World!")).meteredAs("HelloWorld!");
```

#### Requiring Modes

You may want to register a route only for one or more runtime *modes*.

```java
ALL("/.*", (ctx) -> {
  ctx.setHeader("app-name", getSettings().getApplicationName());
  ctx.setHeader("app-version", getSettings().getApplicationVersion());
}).modes(Mode.DEV, Mode.TEST);
```

### Controllers

Controllers in **Fathom-REST** can do a few more tricks than the stock controllers in [Pippo].  In the future many of these tricks may be contributed upstream.

```java
package controllers;

// To be discoverable, a controller must be annotated with @Path.
@Path("/employees")
@Produces({Produces.JSON, Produces.XML})
public class MyController extends Controller {

  @Inject
  EmployeeDao employeeDao;

  @GET("/?")
  @Produces(Produces.HTML)
  public void index() {
    List<Employee> list = employeeDao.getAll();
    getResponse().bind("employees", list).render("employees");
  }

  @GET("/all")
  public List<Employee> getAll() {
    List<Employee> list = employeeDao.getAll();
    return list;
  }

  @GET("/{id: [0-9]+}")
  public Employee getEmployee(int id) {
    // The method parameter name "id" matches the url parameter name "id"
    Employee employee = employeeDao.get(id);
    if (employee == null) {
      getResponse().notFound().send("Failed to find employee {}!", id);
    } else {
      return employee;
    }
  }

}
```

#### Produces and Negotiation

The *Produces* annotation declares the content-types which may be generated by the *controller* method.  You are not required to specify a *Produces* annotation but it may make the intent of your *controller* methods more clear and may be a requirement for use of other [modules](modules.md) like [Fathom-REST-Swagger](rest-swagger.md).

If a *controller* method *Produces* multiple types, the first specified *Content-Type* is used as the default.  A negotiation process will automatically occur to determine and attempt to use the *Accept-Type* preferred by the *Request*.  If one of the preferred *Accept-Types* match one of the *Produces* types, the matching *Accept-Type* will be used for  *Response* generation.  If none of the *Accept-Types* match the *Produces* types, then the default *Content-Type* as declared by the *Produces* annotation will be used for the *Response*.

You may also declare *Produces* on the *controller* class and it will apply, by default, to all methods **unless** the method specifies it's own *Produces* annotation.

#### Transparent Parameter Names

**Fathom-REST** *controllers* make use of the `-parameters` flag of the Java 8 javac compiler.  This flag embeds the names of method parameters in the generated *.class* files.  By default Java 8 does not compile with this flag set so you must specify the `-parameters` compiler argument for your [build system](maven.md) and your IDE.

!!! Note
    You are not required to use this feature.  However, if you choose to skip specifying the `-parameters` flag then you **must** annotate each *controller* method parameter with `@Param("name")`.  Obviously this will make your *controller* method signatures more verbose and you will also be double-maintaining parameter name mappings so use of the `-parameters` compiler flag is recommended.

#### Standard Argument Extractors

Argument Extractors allow you to specify an annotation which instructs **Fathom-REST** how to provide the value of an argument to your *controller* method.

**Fathom-REST** includes the following argument extractors:

| Annotation | Use-Case                                                                            |
|------------|-------------------------------------------------------------------------------------|
| `@Bean`    | Extract url parameters, query parameters, and/or form fields to a Java object       |
| `@Body`    | Marshall a Request body to a Java type via a *Content Type Engine* (e.g. JSON, XML) |
| `@Header`  | Extract a Request header to a standard Java type                                    |
| `@Local`   | Extract a temporary value stored locally within the Request/Response Context        |
| `@Param`   | Extract an url parameter, query parameter, or form field to a standard Java type    |
| `@Session` | Extract a value stored within the Session                                           |

#### Argument Validation

**Fathom-REST** supports implied and explicit argument validation.

1. Implicit validation by regular expression pattern matching of the Route path parameters
2. Implicit `@Required` validation for `@Body` parameters
3. Explicit `@Required` validation for all other argument types
4. Explicit `@Min`, `@Max`, & `@Range` validation for numeric argument types

```java
@POST("/{id: [0-9]+}")
public void renameEmployee(@Min(1) @Max(10) int id, @Required String name) {
}
```

#### Ordering

If you are using annotated *controller* discovery with `@Path` annotations then you are at the mercy of the JVM for registration order of your *controller* methods.

If you need deterministic *controller* method registration order you may specify the `@Order(n)` annotation on some or all *controller* methods.  Lower numbered methods are registered first.

```java
@GET("/{id: [0-9]+}")
@Order(5)
public Employee getEmployee(int id) {
}
```

#### Naming Controller Routes

You may name your controller routes.  This information is used in the registered routes table displayed at startup and during runtime logging of route dispatching.  It may also be used by other [modules](modules.md) like [Fathom-REST-Swagger](rest-swagger.md).

```java
@GET("/{id: [0-9]+}")
@Named("Get employee by id")
public Employee getEmployee(int id) {
}
```

#### Metrics Collection

It's very easy to collect [Metrics](metrics.md) data about your *controllers*.  Simply annotate the methods you want to instrument.

```java
@GET("/{id: [0-9]+}")
@Metered
public Employee getEmployee(int id) {
}
```

#### Declaring Responses Results

You may use the `@Return` annotation to briefly declare method-specific responses.

This has a few benefits.

1. it allows you to implement the logic of your controller without directly relying on the request/response/context objects.
2. it makes the intended results of your controller method execution clear
3. it facilitates api documentation generators or other static analysis tools
4. it allows you to send localized messages on error responses based on the `Accept-Language` of the request
5. it allows you to declare returned headers, validate them, and optionally inject default values

```java
@GET("/{id}")
@Return(code=200, description="Employee retrieved", onResult=Employee.class)
@Return(code=400, description="Invalid id specified", onResult=ValidationException.class)
@Return(code=404, description="Employee not found", descriptionKey="error.employeeNotFound")
@Return(code=404, description="Employee not found", descriptionKey="error.employeeNotFound")
public Employee getEmployee(@Min(1) @Max(5) int id) {
  Employee employee = employeeDao.get(id);
  return employee;
}

@POST("/login")
@Return(code=200, description="Login successful", headers={ApiKeyHeader.class})
public void login(@Form String username, @Form @Password String password) {  
  Account account = securityManager.check(username, password);
  getContext().setHeader(ApiKeyHeader.NAME, account.getToken());
}
```

!!! Note
    You are not required to use the `@Return` annotation.

#### Requiring Settings (Controller)

Your *controller* class may need one or more settings to function and you may specify them as annotated requirements.

Each required setting must be present in the runtime profile [configuration](configuration.md) and must have a non-empty value otherwise the *controller* class will not be registered.

```java
@Path("/secret")
@RequireSetting("allow.secret")
public SecretController extends Controller {
}
```

#### Requiring Settings (Method)

Your *controller* method may need one or more settings to function and you may specify them as annotated requirements.

Each required setting must be present in the runtime profile [configuration](configuration.md) and must have a non-empty value otherwise the *controller* method will not be registered.

```java
@GET("/secret")
@Produces(Produces.HTML)
@RequireSetting("allow.secret")
public void secret() {
  getResponse().render("secret_page");
}
```

#### Requiring Modes (Controller)

You might only want to register a *controller* class in a particular runtime *mode*. This is easily accomplished by using one or more of the mode-specific annotations: `@DEV`, `@TEST`, and `@PROD`.

```java
@Path("/debug")
@DEV @TEST
public DebugController extends Controller {
}
```

#### Requiring Modes (Method)

You might only want to register a *controller* method in a particular runtime *mode*. This is easily accomplished by using one or more of the mode-specific annotations: `@DEV`, `@TEST`, and `@PROD`.

```java
@GET("/debug")
@Produces(Produces.HTML)
@DEV @TEST
public void debug() {
  getResponse().render("debug_page");
}
```

## Template Engines

All standard [Pippo] template engines are supported.

| Engine         | Artifact                     |
|----------------|------------------------------|
| [Freemarker]   | [ro.pippo:pippo-freemarker]  |
| [Jade]         | [ro.pippo:pippo-jade]        |
| [Pebble]       | [ro.pippo:pippo-pebble]      |
| [Trimou]       | [ro.pippo:pippo-trimou]      |
| [Groovy]       | [ro.pippo:pippo-groovy]      |

## Content-Type Engines

All standard [Pippo] content-type engines are supported.

| Content-Type | Engine           | Artifact                     |
|--------------|------------------|------------------------------|
| XML          | JAXB             | *default, built-in*          |
| XML          | [XStream]        | [ro.pippo:pippo-xstream]     |
| JSON         | [GSON]           | [ro.pippo:pippo-gson]        |
| JSON         | [FastJSON]       | [ro.pippo:pippo-fastjson]    |
| JSON         | [Jackson]        | [ro.pippo:pippo-jackson]     |
| YAML         | [SnakeYAML]      | [ro.pippo:pippo-snakeyaml]   |


[Pippo]: http://pippo.ro
[Pippo Routes]: http://www.pippo.ro/doc/routes.html
[AOP method interceptors]: https://github.com/google/guice/wiki/AOP

[Webjars]: http://www.webjars.org
[pretty-time]: http://www.ocpsoft.org/prettytime
[Freemarker]: http://freemarker.org
[Jade]: https://github.com/neuland/jade4j
[Pebble]: http://www.mitchellbosecke.com/pebble/home
[Trimou]: http://trimou.org
[Groovy]: https://github.com/decebals/pippo/tree/master/pippo-groovy

[XStream]: https://github.com/x-stream/xstream
[GSON]: https://github.com/google/gson
[FastJSON]: https://github.com/alibaba/fastjson
[Jackson]: https://github.com/FasterXML/jackson
[SnakeYAML]: https://bitbucket.org/asomov/snakeyaml

[ro.pippo:pippo-freemarker]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-freemarker"
[ro.pippo:pippo-jade]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-jade"
[ro.pippo:pippo-pebble]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-pebble"
[ro.pippo:pippo-trimou]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-trimou"
[ro.pippo:pippo-groovy]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-groovy"

[ro.pippo:pippo-xstream]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-xstream"
[ro.pippo:pippo-gson]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-gson"
[ro.pippo:pippo-fastjson]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-fastjson"
[ro.pippo:pippo-jackson]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-jackson"
[ro.pippo:pippo-snakeyaml]: http://search.maven.org/#search|ga|1|g:"ro.pippo"%20AND%20a:"pippo-snakeyaml"
